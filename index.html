<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>TEAM Runners</title>
<style>
  :root{
    --red:#C9301F; --blue:#132766; --ink:#0c1228; --bg:#f4f6fb;
    --glass:rgba(255,255,255,.74); --stroke:rgba(16,20,42,.08);
  }
  *{box-sizing:border-box}
  html,body{
    height:100%; margin:0; background:var(--bg); color:var(--ink);
    font-family:ui-sans-serif,-apple-system,BlinkMacSystemFont,Inter,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:28px;
    background:
      radial-gradient(900px 600px at 90% -10%, rgba(201,48,31,.08), transparent 60%),
      radial-gradient(1000px 700px at -10% 100%, rgba(19,39,102,.08), transparent 60%),
      var(--bg);}
  .stage{
    position:relative;width:min(96vw,140vh);aspect-ratio:16/9;overflow:hidden;border-radius:28px;background:#fff;
    box-shadow:0 28px 80px rgba(18,25,66,.18), inset 0 0 0 1px var(--stroke);
  }
  #game{position:absolute;inset:0;width:100%;height:100%;background:#fff;image-rendering:pixelated}

  /* HUD */
  .hud{position:absolute;inset:0;pointer-events:none;padding:16px}
  .nick,.caps .cap{
    height:34px;padding:0 14px;display:flex;align-items:center;gap:8px;border-radius:20px;background:var(--glass);
    backdrop-filter:saturate(140%) blur(10px);
    box-shadow:0 2px 8px rgba(10,12,28,.08), inset 0 0 0 1px rgba(10,12,28,.07);
    font-weight:800;font-size:13px;letter-spacing:.2px;font-variant-numeric:tabular-nums;
  }
  .nick{position:absolute;left:16px;top:16px}
  .caps{position:absolute;right:16px;top:16px;display:flex;gap:10px}
  .cap.red{color:var(--red)}

  /* PANELS */
  .panel{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    background:linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.65));
    backdrop-filter:blur(14px) saturate(140%);padding:24px;}
  .card{width:min(560px,92%);background:#fff;border-radius:24px;padding:22px;box-shadow:0 40px 80px rgba(18,25,66,.18), inset 0 0 0 1px var(--stroke)}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  input[type="text"]{width:100%;padding:12px 14px;border:1px solid rgba(18,25,66,.18);border-radius:14px;outline:none;font-size:16px}
  .btn{pointer-events:auto;display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:14px;border:0;cursor:pointer;font-weight:900;letter-spacing:.2px;box-shadow:0 10px 30px rgba(18,25,66,.15)}
  .btn.red{background:linear-gradient(135deg,var(--red),#b12a1b);color:#fff}
  .btn.blue{background:linear-gradient(135deg,var(--blue),#0a1540);color:#fff}
  .btn.ghost{background:#fff;color:var(--blue);border:1px solid rgba(18,25,66,.22)}
  .btn[disabled]{opacity:.5;cursor:not-allowed;filter:grayscale(.2)}

  /* Leaderboard */
  .table{width:100%;border-collapse:separate;border-spacing:0 10px;margin-top:10px;font-variant-numeric:tabular-nums}
  .table tr{background:#f6f8ff;border-radius:12px}
  .table tr.me{background:#fff3f1}
  .table td{padding:10px 12px}
  .pos{width:48px;text-align:center;font-weight:900;color:var(--blue)}
  .nickc{font-weight:900}
  .val{font-weight:900;color:var(--red)}

  .toast{position:absolute;left:50%;top:10%;transform:translateX(-50%);background:#10142a;color:#fff;padding:10px 14px;border-radius:12px;display:none;box-shadow:0 14px 28px rgba(0,0,0,.22)}
  .toast.show{display:block;animation:pop .9s ease}
  @keyframes pop{0%{transform:translate(-50%,-10px);opacity:0}20%{opacity:1}80%{opacity:1}100%{opacity:0}}
</style>
</head>
<body>
<div class="wrap">
  <div class="stage">
    <canvas id="game" width="1920" height="1080"></canvas>

    <div class="hud">
      <div class="nick" id="nickBadge">üë§ –ù–∏–∫: ‚Äî</div>
      <div class="caps">
        <div class="cap red"><span id="score">0</span></div>
        <div class="cap"><span id="best">0</span></div>
      </div>
    </div>

    <!-- START -->
    <div class="panel" id="startPanel">
      <div class="card">
        <div class="row" style="width:100%">
          <input id="nickInput" type="text" maxlength="20" placeholder="–ù–∏–∫–Ω–µ–π–º (A‚ÄìZ, 0‚Äì9, –ø—Ä–æ–±–µ–ª—ã, _.-)"/>
          <button class="btn red" id="startBtn" disabled>‚ñ∂ –ù–∞—á–∞—Ç—å</button>
          <button class="btn blue" id="openLbBtn">üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥</button>
        </div>
      </div>
    </div>

    <!-- OVER -->
    <div class="panel" id="overPanel" style="display:none">
      <div class="card">
        <div class="row" style="justify-content:space-between;width:100%">
          <div class="row"><b>–°—á—ë—Ç: <span id="finalScore">0</span></b></div>
          <div class="row"><b>–†–µ–∫–æ—Ä–¥: <span id="finalBest">0</span></b></div>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn red" id="retryBtn">‚Üª –ï—â—ë —Ä–∞–∑</button>
          <button class="btn blue" id="lbBtn2">üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥</button>
        </div>
      </div>
    </div>

    <!-- LEADERBOARD -->
    <div class="panel" id="lbPanel" style="display:none">
      <div class="card">
        <div class="row" style="justify-content:flex-end;margin-bottom:8px">
          <button class="btn ghost" id="backBtn">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
        <table class="table" id="lbTable"></table>
      </div>
    </div>

    <div class="toast" id="toast">–ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥! üî•</div>
  </div>
</div>

<script>
/* ===== Math utils ===== */
const BRAND_RED='#C9301F', BRAND_BLUE='#132766';
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const rand=(a,b)=>Math.random()*(b-a)+a;
const lerp=(a,b,t)=>a+(b-a)*t;

/* ===== Audio ===== */
class Sound{
  constructor(){try{this.a=new (window.AudioContext||window.webkitAudioContext)();}catch(e){}}
  b({f=600,d=.08,t='square',g=.05,a=.005,r=.02,s=0}={}){if(!this.a)return;const c=this.a,t0=c.currentTime,o=c.createOscillator(),gn=c.createGain();o.type=t;o.frequency.setValueAtTime(f,t0);if(s)o.frequency.exponentialRampToValueAtTime(Math.max(40,f+s),t0+d);gn.gain.setValueAtTime(0,t0);gn.gain.linearRampToValueAtTime(g,t0+a);gn.gain.setValueAtTime(g,t0+d-r);gn.gain.linearRampToValueAtTime(0,t0+d);o.connect(gn);gn.connect(c.destination);o.start(t0);o.stop(t0+d+.02);}
  jump(){this.b({f:520,d:.09,t:'square',g:.06,s:120});}
  land(){this.b({f:420,d:.06,t:'triangle',g:.05,s:-80});}
  hit(){this.b({f:170,d:.12,t:'sawtooth',g:.08,s:-140});}
  tick(){this.b({f:900,d:.05,t:'triangle',g:.045});}
  milestone(){this.b({f:640,d:.25,t:'square',g:.07,s:260});}
}
const SND=new Sound();

/* ===== Storage (best-per-nick, –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–æ) ===== */
const KEY='TR_STATE_LOCK_V2', LBKEY='TR_LB_LOCK_V2';
const normNick = (n)=> (n||'').toString().trim().replace(/\s+/g,' ').replace(/[^A-Za-z0-9 _.-]/g,'').toLowerCase();
const prettyNick = (n)=> (n||'Player').replace(/\s+/g,' ').trim().replace(/\b([a-z])/g,m=>m.toUpperCase());
const store={
  state(){ try{return JSON.parse(localStorage.getItem(KEY))||{nick:'',best:0};}catch(e){return {nick:'',best:0};} },
  save(s){ localStorage.setItem(KEY, JSON.stringify(s)); },
  lb(){
    let raw=null; try{raw=JSON.parse(localStorage.getItem(LBKEY));}catch(e){}
    return (raw && typeof raw==='object' && !Array.isArray(raw)) ? raw : {};
  },
  setBest(nick,score){
    const key=normNick(nick); if(!key) return;
    const disp=prettyNick(nick);
    const lb=this.lb();
    if(!lb[key] || score>lb[key].score) lb[key]={nick:disp,score,ts:Date.now()};
    localStorage.setItem(LBKEY, JSON.stringify(lb));
  }
};

/* ===== Canvas & scene ===== */
const cvs=document.getElementById('game'), ctx=cvs.getContext('2d');
const W=cvs.width, H=cvs.height, groundY=H-210;
let last=0, dt=0, running=false, over=false;

/* ===== Game state (—É—Å–∫–æ—Ä—ë–Ω–Ω—ã–π —Å—á—ë—Ç) ===== */
let score=0, speed=8.2, difficulty=1;
const state=store.state(); let best=state.best||0;

/* ===== Rounded primitives ===== */
function roundRect(x,y,w,h,r,fill){ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();ctx.fillStyle=fill;ctx.fill();}
function roundedBlob(x,y,w,h,r,color){roundRect(x,y,w,h,r,color);}

/* ===== Player: Apple-ish capsule with squash & stretch ===== */
class Player{
  constructor(){this.reset();}
  reset(){
    this.x=260; this.y=groundY; this.w=64; this.h=88;
    this.vy=0; this.onGround=true; this.hold=.16; this.anim=0;
    this.squashX=1; this.squashY=1; // for squash/stretch
    this.landCooldown=0;
  }
  startJump(){
    if(this.onGround){
      this.vy=-19; this.onGround=false; this.hold=.16;
      // stretch up
      this.squashX=0.92; this.squashY=1.08;
      SND.jump();
    }
  }
  holdJump(h){ if(h&&this.hold>0){ this.vy-=0.9; this.hold-=dt; } }
  update(){
    this.vy += 0.96;
    this.y  += this.vy;
    if(this.y>=groundY){
      if(!this.onGround){ SND.land(); this.landCooldown=0.12; }
      this.y=groundY; this.vy=0; this.onGround=true;
    }else{
      this.onGround=false;
    }
    // body animation
    this.anim += dt*(12 + speed*0.55);
    // bob & squash easing
    this.squashX = lerp(this.squashX, 1, 0.2);
    this.squashY = lerp(this.squashY, 1, 0.2);
    if(this.onGround && this.landCooldown>0){
      this.squashX = 1.08; this.squashY = 0.92;
      this.landCooldown -= dt;
    }
  }
  draw(){
    const x=this.x, y=this.y, h=this.h, w=this.w;
    const bob = this.onGround ? Math.sin(this.anim*0.6)*2 : 0;

    // shadow
    ctx.save();
    ctx.fillStyle='rgba(0,0,0,.10)';
    roundRect(x+12, groundY+h-6, 92, 14, 7, 'rgba(0,0,0,.10)');
    ctx.restore();

    ctx.save();
    ctx.translate(x+32, y+44+bob);
    ctx.scale(this.squashX, this.squashY); // squash/stretch around center

    // legs ‚Äî rotating capsules
    const legPhase = Math.sin(this.anim*0.7);
    drawCapsule(-8, 28, 16, 28, 8, BRAND_RED, legPhase*-0.35);
    drawCapsule( 8,  28, 16, 28, 8, BRAND_RED, legPhase*0.35);

    // torso
    roundRect(-22, -2, 44, 42, 12, BRAND_RED);
    // head
    roundRect(-15, -28, 30, 26, 10, BRAND_BLUE);
    // visor/eye
    roundRect(4, -18, 8, 8, 3, '#fff');
    roundRect(6, -16, 4, 4, 2, '#111');
    // arms
    drawCapsule(-34, 6, 18, 12, 6, BRAND_RED, -0.15);
    drawCapsule( 16, 6, 18, 12, 6, BRAND_RED,  0.15);
    // stripe
    roundRect(-18, 12, 36, 6, 3, '#fff');

    ctx.restore();
  }
  bbox(){return{x:this.x+8,y:this.y+6,w:this.w-16,h:this.h-12};}
}
function drawCapsule(cx,cy,w,h,r,color,rot=0){
  ctx.save();
  ctx.translate(cx,cy);
  ctx.rotate(rot);
  roundRect(-w/2,-h/2,w,h,r,color);
  ctx.restore();
}

/* ===== Obstacles: –±–æ–ª—å—à–µ –∏ –ø–ª–æ—Ç–Ω–µ–µ ===== */
class Obstacle{
  constructor(x,t=0){
    this.x=x; this.t=t; this.passed=false;
    if(t===0){this.w=48;this.h=58;}         // –º–∞–ª—ã–π —Å—Ç–æ–ª–±–∏–∫
    else if(t===1){this.w=60;this.h=98;}    // –≤—ã—Å–æ–∫–∏–π
    else if(t===2){this.w=80;this.h=64;}    // —à–∏—Ä–æ–∫–∏–π
    else if(t===3){this.w=62;this.h=112;}   // –∑–Ω–∞–∫
    else if(t===4){this.w=42;this.h=50;}    // –±—ã—Å—Ç—Ä—ã–µ –¥–≤–æ–π–Ω–∏–∫–∏
    this.y=groundY+player.h-this.h;
  }
  update(){
    this.x -= speed*(1+Math.min(.75, difficulty*.18));
    if(!this.passed && this.x+this.w<player.x){
      this.passed=true; score+=20; // –±–æ–Ω—É—Å –∑–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è (–±—ã—Å—Ç—Ä–µ–µ —Ä–∞—Å—Ç—ë—Ç)
      (score%400===0)?SND.milestone():SND.tick();
    }
  }
  draw(){
    // shadow
    roundRect(this.x+6, this.y+this.h-8, Math.max(24,this.w-6), 8, 4, 'rgba(0,0,0,.12)');
    if(this.t===3){
      roundRect(this.x, this.y-10, this.w, this.h+12, 12, BRAND_BLUE);
      roundRect(this.x+10, this.y+8, this.w-20, this.h-30, 10, '#fff');
      roundRect(this.x+14, this.y+14, this.w-28, 12, 6, BRAND_RED);
      roundRect(this.x+14, this.y+30, this.w-28, 12, 6, BRAND_BLUE);
    }else{
      const c = (this.t===4)? '#E04B3C' : BRAND_RED;
      roundRect(this.x, this.y, this.w, this.h, 12, c);
      roundRect(this.x+8, this.y+8, this.w-16, 6, 3, '#ffffff66');
    }
  }
  bbox(){return{x:this.x+6,y:this.y+6,w:this.w-12,h:this.h-12};}
}

/* ===== Background (–ø–ª–∞–≤–Ω–∞—è –∫–∞—Ä—Ç–∞, –±–µ–∑ –¥—Ä–æ–∂–∏) ===== */
function drawBG(t){
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,W,H);
  // —Ä–µ–∫–∏/–≥–∞–∑–æ–Ω—ã
  roundedBlob(-80,380,620,300,50,'#e7f1ff');
  roundedBlob(W-540,220,620,300,50,'#e7f1ff');
  roundedBlob(W/2-110,260,220,400,40,'#e7f1ff');
  roundedBlob(80,80,300,180,40,'#eef6e9');
  roundedBlob(W-420,60,280,160,36,'#eef6e9');

  drawRibbonRoad(t);

  const Y=groundY+player.h;
  roundRect(0,Y,W,190,24,'#f2f4fb');
  roundRect(0,Y-10,W,12,6,BRAND_RED);
  const shift=(t*0.26)%72;
  for(let i=-shift;i<W;i+=72){ roundRect(i, Y+72, 48, 6, 3, 'rgba(19,39,102,.12)'); }

  drawCityBlocks();
}
function drawRibbonRoad(t){
  const y0=320, amp=26, len=W+200;
  const y = x => y0 + Math.sin((x+t*0.0007)/180*Math.PI)*amp;
  ctx.strokeStyle='#ffe27a'; ctx.lineWidth=28; ctx.lineCap='round';
  ctx.beginPath(); ctx.moveTo(-100,y(-100)); for(let x=-100;x<len;x+=20) ctx.lineTo(x,y(x)); ctx.stroke();
  ctx.strokeStyle='rgba(0,0,0,.10)'; ctx.lineWidth=2; ctx.stroke();
  for(let i=0;i<7;i++){ const cx=(t*0.18+i*220)%(W+300)-150; const cy=y(cx)+(i%2?-6:6);
    roundRect(cx,cy-7,22,14,7, i%3===0?'#5ac8fa':(i%3===1?'#34c759':'#ff3b30')); }
}
function drawCityBlocks(){
  const blocks=[[120,140,90,70,'#ffd9dd'],[260,200,110,80,'#d9e7ff'],[520,120,100,90,'#e7ffe0'],[860,140,120,82,'#ffecca'],[1120,110,100,78,'#e3e2ff'],[1450,160,110,84,'#ffd9f2']];
  for(const b of blocks){
    ctx.globalAlpha=.6; roundRect(b[0],b[1],b[2],b[3],18,b[4]); ctx.globalAlpha=1;
    for(let i=0;i<3;i++) for(let j=0;j<2;j++) roundRect(b[0]+18+i*24,b[1]+16+j*22,12,10,3,'rgba(0,0,0,.08)');
  }
}

/* ===== Particles ===== */
const Particles={items:[],spawn(x,y,c){this.items.push({x,y,vx:rand(-1.2,1.2),vy:rand(-1.6,-.4),a:1,c,life:rand(.45,.8)});},
  update(dt){this.items=this.items.filter(p=>{p.vx*=.99;p.vy+=.12;p.x+=p.vx;p.y+=p.vy;p.life-=dt;p.a=Math.max(0,p.life/.8);return p.life>0;});},
  draw(){for(const p of this.items){ctx.globalAlpha=p.a;roundRect(p.x,p.y,6,6,3,p.c);}ctx.globalAlpha=1;}
};

/* ===== Entities & loop ===== */
const player=new Player();
const obstacles=[]; let spawnT=0;

function spawnObstacle(){
  // –ë–û–õ–¨–®–ï –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π: –∫–æ—Ä–æ—á–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã + –∏–Ω–æ–≥–¥–∞ ¬´–¥–≤–æ–π–Ω–∏–∫–∏¬ª
  const minGap=Math.max(200 - difficulty*7, 110);
  const maxGap=Math.max(340 - difficulty*5, 160);
  const lastX=obstacles.length?obstacles[obstacles.length-1].x:W+420;
  let nx=Math.max(W+rand(minGap,maxGap), lastX+rand(minGap*0.8,maxGap));
  let t=0; const r=Math.random();
  if(r<.40)t=0; else if(r<.70)t=1; else if(r<.90)t=2; else if(r<.96)t=3; else t=4;

  // –¥–ª—è —Ç–∏–ø–∞ 4 ‚Äî —Å–ø–∞–≤–Ω–∏–º –¥–≤–∞ –ø–æ–¥—Ä—è–¥
  if(t===4){
    obstacles.push(new Obstacle(nx,4));
    obstacles.push(new Obstacle(nx+rand(70,100),0));
  }else{
    obstacles.push(new Obstacle(nx,t));
  }
}

function resetRound(){score=0;speed=8.2;difficulty=1;spawnT=0;obstacles.length=0;player.reset();over=false;}

function step(ts){
  if(!running){last=ts;requestAnimationFrame(step);return;}
  dt=Math.min(.033,(ts-last)/1000); last=ts;

  // –ø–ª–∞–≤–Ω–∞—è, –Ω–æ –±–æ–¥—Ä–∞—è –∫—Ä–∏–≤–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
  difficulty += dt*0.8;
  speed = lerp(speed, 8.2 + difficulty*1.25, .02);

  spawnT -= dt;
  if(spawnT<=0){
    spawnObstacle();
    const base = clamp(1.05 - difficulty*0.025, .30, 1.05); // —á–∞—â–µ —Å–ø–∞–≤–Ω
    spawnT = base + Math.random()*0.18;
  }

  drawBG(ts);

  for(const o of obstacles){ o.update(); o.draw(); }
  player.update(); player.draw();

  Particles.update(dt); Particles.draw();

  // –∫–æ–ª–ª–∏–∑–∏–∏
  const pb=player.bbox();
  for(const o of obstacles){
    const b={x:o.x+6,y:o.y+6,w:o.w-12,h:o.h-12};
    if(!(pb.x+pb.w<b.x||pb.x>b.x+b.w||pb.y+pb.h<b.y||pb.y>b.y+b.h)){ return gameOver(); }
  }
  while(obstacles.length && obstacles[0].x+obstacles[0].w<-60) obstacles.shift();

  // –£–°–ö–û–†–ï–ù–ù–´–ô —Å—á—ë—Ç: –±—ã—Å—Ç—Ä–µ–µ ¬´—Ç–µ—á—ë—Ç¬ª + –±–æ–Ω—É—Å—ã –∑–∞ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –≤—ã—à–µ (—Å–º. update)
  score += Math.floor(dt*(80 + speed*8));
  document.getElementById('score').textContent=String(score);
  document.getElementById('best').textContent=String(best);

  requestAnimationFrame(step);
}

/* ===== UI & controls ===== */
const startPanel=document.getElementById('startPanel');
const overPanel=document.getElementById('overPanel');
const lbPanel=document.getElementById('lbPanel');
const finalScore=document.getElementById('finalScore');
const finalBest=document.getElementById('finalBest');
const nickBadge=document.getElementById('nickBadge');
const toast=document.getElementById('toast');
const nickInput=document.getElementById('nickInput');
const startBtn=document.getElementById('startBtn');

function show(panel){startPanel.style.display='none';overPanel.style.display='none';lbPanel.style.display='none';panel.style.display='';}
function toastMsg(t){toast.textContent=t;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),1100);}

function setNick(n){
  const cleaned=(n||'').toString().trim().replace(/\s+/g,' ').replace(/[^A-Za-z0-9 _.-]/g,'');
  const key=normNick(cleaned);
  state.nick = cleaned && key ? cleaned : '';
  nickBadge.textContent='üë§ –ù–∏–∫: '+(state.nick||'‚Äî');
  store.save(state);
  startBtn.disabled = !state.nick;
}
function ensureNick(){ nickBadge.textContent='üë§ –ù–∏–∫: '+(state.nick||'‚Äî'); startBtn.disabled=!state.nick; }

nickInput.addEventListener('input', ()=> setNick(nickInput.value));

function startGame(){
  if(!state.nick) return; // –Ω–µ –ø—É—Å–∫–∞–µ–º –±–µ–∑ –Ω–∏–∫–∞
  show(startPanel); startPanel.style.display='none';
  running=true; resetRound(); ensureNick();
  if(SND.a&&SND.a.state==='suspended') SND.a.resume();
  requestAnimationFrame(step);
}
function gameOver(){
  if(over) return; over=true; running=false; SND.hit();
  for(let i=0;i<26;i++) Particles.spawn(player.x+rand(-10,40), player.y+rand(0,60), Math.random()<.5?BRAND_RED:BRAND_BLUE);
  if(score>(state.best||0)){ state.best=score; store.save(state); best=state.best; toastMsg('–ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥! üî•'); }
  store.setBest(state.nick, score);
  finalScore.textContent=String(score);
  finalBest.textContent=String(best);
  show(overPanel);
}

/* Leaderboard (—É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º—É –Ω–∏–∫—É) */
function buildLB(){
  const t=document.getElementById('lbTable'), lb=store.lb();
  const rows=Object.entries(lb).map(([key,v])=>({nick:v.nick||key,score:v.score|0,ts:v.ts|0,key}))
               .sort((a,b)=>b.score-a.score).slice(0,200);
  if(!rows.length){ t.innerHTML='<tr><td class="pos">‚Äî</td><td class="nickc">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td><td class="val">0</td></tr>'; return; }
  let html=''; rows.forEach((r,i)=>{ const me=(normNick(state.nick)===r.key);
    html+=`<tr class="${me?'me':''}"><td class="pos">${i+1}</td><td class="nickc">${escapeHtml(r.nick)}</td><td class="val">${r.score}</td></tr>`; });
  t.innerHTML=html;
}
const escapeHtml=s=>(s+'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

/* Buttons */
document.getElementById('openLbBtn').onclick=()=>{buildLB();show(lbPanel);};
document.getElementById('lbBtn2').onclick=()=>{buildLB();show(lbPanel);};
document.getElementById('backBtn').onclick=()=>{show(startPanel);};
startBtn.onclick=startGame;
document.getElementById('retryBtn').onclick=()=>{startGame();};

/* Controls */
let holding=false;
const press=()=>{if(!running)return;player.startJump();holding=true;};
const release=()=>{holding=false;};
window.addEventListener('keydown',e=>{if(e.code==='Space'||e.code==='ArrowUp'){e.preventDefault();press();}});
window.addEventListener('keyup',e=>{if(e.code==='Space'||e.code==='ArrowUp'){e.preventDefault();release();}});
cvs.addEventListener('pointerdown',press); window.addEventListener('pointerup',release);
(function holdLoop(){if(running)player.holdJump(holding);requestAnimationFrame(holdLoop);})();

/* Init */
ensureNick();
document.getElementById('best').textContent=String(best);
requestAnimationFrame(step);
</script>
</body>
</html>
