<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>TEAM Runners ‚Äî Portrait</title>
<style>
  :root{
    --ink:#0c1220; --bg:#f6f7fb; --panel:#ffffff; --glass:rgba(255,255,255,.78);
    --shadow:0 28px 80px rgba(10,14,40,.18), inset 0 0 0 1px rgba(10,14,40,.06);
    --red:#D13A2A; --blue:#162A66;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
    font-family:ui-sans-serif,-apple-system,BlinkMacSystemFont,Inter,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
  .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:20px}
  /* –ü–æ—Ä—Ç—Ä–µ—Ç–Ω–∞—è —Å—Ü–µ–Ω–∞: 9/16, –∑–∞–Ω–∏–º–∞–µ—Ç –≤—ã—Å–æ—Ç—É */
  .stage{
    position:relative; height:min(96vh, 900px); aspect-ratio:9/16; width:auto;
    max-width:92vw; border-radius:28px; overflow:hidden; background:var(--panel); box-shadow:var(--shadow);
  }
  #game{position:absolute; inset:0; width:100%; height:100%; background:#fff; image-rendering:pixelated}

  /* HUD */
  .hud{position:absolute; inset:0; pointer-events:none; padding:12px}
  .row{display:flex; gap:8px; align-items:center}
  .nick, .cap{
    height:30px; padding:0 12px; display:flex; align-items:center; gap:8px; border-radius:999px;
    background:var(--glass); box-shadow:0 2px 8px rgba(10,14,40,.10), inset 0 0 0 1px rgba(10,14,40,.06);
    font-weight:800; font-size:13px; letter-spacing:.2px; font-variant-numeric:tabular-nums;
    backdrop-filter:saturate(140%) blur(10px);
  }
  .hud-top{position:absolute; top:12px; left:12px; right:12px; display:flex; justify-content:space-between}
  .cap.red{color:var(--red)}

  /* –ü–∞–Ω–µ–ª–∏ */
  .panel{position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    background:linear-gradient(180deg, rgba(255,255,255,.88), rgba(255,255,255,.70));
    backdrop-filter:blur(14px) saturate(140%); padding:16px}
  .card{width:min(520px, 88%); background:#fff; border-radius:24px; padding:18px; box-shadow:var(--shadow)}
  .controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  input[type="text"]{width:100%; padding:12px 14px; border:1px solid #d7dbe7; border-radius:14px; outline:none; font-size:16px}
  .btn{pointer-events:auto; display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:12px 16px; border-radius:14px; border:0; cursor:pointer; font-weight:900; letter-spacing:.2px;
    box-shadow:0 10px 30px rgba(10,14,40,.14)}
  .btn.red{background:linear-gradient(135deg, var(--red), #b42f22); color:#fff}
  .btn.blue{background:linear-gradient(135deg, var(--blue), #0c163e); color:#fff}
  .btn.ghost{background:#fff; color:var(--blue); border:1px solid #d7dbe7}
  .btn[disabled]{opacity:.5; cursor:not-allowed; filter:grayscale(.2)}

  /* –õ–∏–¥–µ—Ä–±–æ—Ä–¥ */
  .table{width:100%; border-collapse:separate; border-spacing:0 8px; margin-top:6px; font-variant-numeric:tabular-nums}
  .table tr{background:#f5f7ff; border-radius:12px}
  .table tr.me{background:#fff2ef}
  .table td{padding:10px 12px}
  .pos{width:48px; text-align:center; font-weight:900; color:var(--blue)}
  .nickc{font-weight:900}
  .val{font-weight:900; color:var(--red)}

  .toast{position:absolute; left:50%; top:8%; transform:translateX(-50%); background:#0b0f27; color:#fff; padding:10px 14px; border-radius:12px; display:none; box-shadow:0 14px 28px rgba(0,0,0,.22)}
  .toast.show{display:block; animation:pop .9s ease}
  @keyframes pop{0%{transform:translate(-50%,-10px);opacity:0}20%{opacity:1}80%{opacity:1}100%{opacity:0}}
</style>
</head>
<body>
<div class="wrap">
  <div class="stage">
    <!-- –ü–æ—Ä—Ç—Ä–µ—Ç–Ω—ã–π –∫–∞–Ω–≤–∞—Å 1080√ó1920 -->
    <canvas id="game" width="1080" height="1920"></canvas>

    <!-- HUD -->
    <div class="hud">
      <div class="hud-top">
        <div class="row"><div class="nick" id="nickBadge">üë§ –ù–∏–∫: ‚Äî</div></div>
        <div class="row">
          <div class="cap red"><span id="score">0</span></div>
          <div class="cap"><span id="best">0</span></div>
        </div>
      </div>
    </div>

    <!-- START -->
    <div class="panel" id="startPanel">
      <div class="card">
        <div class="controls" style="width:100%">
          <input id="nickInput" type="text" maxlength="20" placeholder="–ù–∏–∫ (A‚ÄìZ, 0‚Äì9, –ø—Ä–æ–±–µ–ª—ã, _.-)"/>
          <button class="btn red" id="startBtn" disabled>‚ñ∂ –ù–∞—á–∞—Ç—å</button>
          <button class="btn blue" id="openLbBtn">üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥</button>
        </div>
      </div>
    </div>

    <!-- OVER -->
    <div class="panel" id="overPanel" style="display:none">
      <div class="card">
        <div class="controls" style="justify-content:space-between;width:100%">
          <b>–°—á—ë—Ç: <span id="finalScore">0</span></b>
          <b>–†–µ–∫–æ—Ä–¥: <span id="finalBest">0</span></b>
        </div>
        <div class="controls" style="margin-top:12px">
          <button class="btn red" id="retryBtn">‚Üª –ï—â—ë —Ä–∞–∑</button>
          <button class="btn blue" id="lbBtn2">üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥</button>
        </div>
      </div>
    </div>

    <!-- LEADERBOARD -->
    <div class="panel" id="lbPanel" style="display:none">
      <div class="card">
        <div class="controls" style="justify-content:flex-end;margin-bottom:8px">
          <button class="btn ghost" id="backBtn">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
        <table class="table" id="lbTable"></table>
      </div>
    </div>

    <div class="toast" id="toast">–ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥! üî•</div>
  </div>
</div>

<script>
/* ===== –±–∞–∑–æ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã ===== */
const RED='#D13A2A', BLUE='#162A66';
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const rand=(a,b)=>Math.random()*(b-a)+a;
const lerp=(a,b,t)=>a+(b-a)*t;

/* ===== –∑–≤—É–∫ ===== */
class Sound{
  constructor(){try{this.a=new (window.AudioContext||window.webkitAudioContext)();}catch(e){}}
  b({f=600,d=.08,t='square',g=.05,a=.005,r=.02,s=0}={}){if(!this.a)return;const c=this.a,t0=c.currentTime,o=c.createOscillator(),gn=c.createGain();o.type=t;o.frequency.setValueAtTime(f,t0);if(s)o.frequency.exponentialRampToValueAtTime(Math.max(40,f+s),t0+d);gn.gain.setValueAtTime(0,t0);gn.gain.linearRampToValueAtTime(g,t0+a);gn.gain.setValueAtTime(g,t0+d-r);gn.gain.linearRampToValueAtTime(0,t0+d);o.connect(gn);gn.connect(c.destination);o.start(t0);o.stop(t0+d+.02);}
  jump(){this.b({f:520,d:.09,t:'square',g:.06,s:120});}
  land(){this.b({f:420,d:.06,t:'triangle',g:.05,s:-80});}
  hit(){this.b({f:170,d:.12,t:'sawtooth',g:.08,s:-140});}
  tick(){this.b({f:900,d:.05,t:'triangle',g:.045});}
  milestone(){this.b({f:640,d:.25,t:'square',g:.07,s:260});}
}
const SND=new Sound();

/* ===== —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (–æ–¥–∏–Ω –ª—É—á—à–∏–π –Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –Ω–∏–∫) ===== */
const KEY='TR_STATE_PORTRAIT_V1', LBKEY='TR_LB_PORTRAIT_V1';
const normNick = n => (n||'').toString().trim().replace(/\s+/g,' ').replace(/[^A-Za-z0-9 _.-]/g,'').toLowerCase();
const prettyNick = n => (n||'Player').replace(/\s+/g,' ').trim().replace(/\b([a-z])/g,m=>m.toUpperCase());
const store={
  state(){try{return JSON.parse(localStorage.getItem(KEY))||{nick:'',best:0};}catch(e){return {nick:'',best:0};}},
  save(s){localStorage.setItem(KEY,JSON.stringify(s));},
  lb(){let raw;try{raw=JSON.parse(localStorage.getItem(LBKEY));}catch(e){};return (raw&&typeof raw==='object')?raw:{};},
  setBest(nick,score){const key=normNick(nick); if(!key) return; const disp=prettyNick(nick); const lb=this.lb(); if(!lb[key]||score>lb[key].score) lb[key]={nick:disp,score,ts:Date.now()}; localStorage.setItem(LBKEY,JSON.stringify(lb));}
};

/* ===== –∫–∞–Ω–≤–∞—Å (–ø–æ—Ä—Ç—Ä–µ—Ç) ===== */
const cvs=document.getElementById('game'), ctx=cvs.getContext('2d');
const W=cvs.width, H=cvs.height;
const groundY = H - 480;           // ¬´–∑–µ–º–ª—è¬ª –≤—ã—à–µ ‚Äî –ø–æ–¥ –ø–æ—Ä—Ç—Ä–µ—Ç
let last=0, dt=0, running=false, over=false;

/* ===== —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã (–±—ã—Å—Ç—Ä—ã–π —Å—á—ë—Ç) ===== */
let score=0, speed=8.2, difficulty=1;
const state=store.state(); let best=state.best||0;

/* ===== –ø—Ä–∏–º–∏—Ç–∏–≤—ã ===== */
function roundRect(x,y,w,h,r,fill){ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();ctx.fillStyle=fill;ctx.fill();}
function strokeRoundRect(x,y,w,h,r,stroke,width,alpha=1){ctx.save();ctx.globalAlpha=alpha;ctx.lineWidth=width;ctx.strokeStyle=stroke;ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();ctx.stroke();ctx.restore();}
function drawCapsule(cx,cy,w,h,r,color,rot=0){ctx.save();ctx.translate(cx,cy);ctx.rotate(rot);roundRect(-w/2,-h/2,w,h,r,color);ctx.restore();}

/* ===== –ø–µ—Ä—Å–æ–Ω–∞–∂ (–º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π) ===== */
class Player{
  constructor(){this.reset();}
  reset(){this.x=W*0.38; this.y=groundY; this.w=66; this.h=90; this.vy=0; this.onGround=true; this.hold=.16; this.anim=0; this.sx=1; this.sy=1; this.landCd=0;}
  startJump(){ if(this.onGround){ this.vy=-20; this.onGround=false; this.hold=.17; this.sx=0.92; this.sy=1.08; SND.jump(); } }
  holdJump(h){ if(h&&this.hold>0){ this.vy-=0.9; this.hold-=dt; } }
  update(){
    this.vy+=0.98; this.y+=this.vy;
    if(this.y>=groundY){ if(!this.onGround){SND.land(); this.landCd=0.12;} this.y=groundY; this.vy=0; this.onGround=true; } else this.onGround=false;
    this.anim+=dt*(13+speed*0.6);
    this.sx=lerp(this.sx,1,0.2); this.sy=lerp(this.sy,1,0.2);
    if(this.onGround && this.landCd>0){ this.sx=1.08; this.sy=0.92; this.landCd-=dt; }
  }
  draw(){
    const x=this.x,y=this.y,h=this.h;
    roundRect(x+12, groundY+h-6, 92, 14, 7, 'rgba(0,0,0,.10)');
    ctx.save(); ctx.translate(x+33,y+44); ctx.scale(this.sx,this.sy);
    const phase=Math.sin(this.anim*0.75);
    drawCapsule(-8, 28, 16, 28, 8, RED, phase*-0.35);
    drawCapsule( 8, 28, 16, 28, 8, RED, phase*0.35);
    roundRect(-22,-2,44,42,12,RED); strokeRoundRect(-22,-2,44,42,12,'rgba(0,0,0,.08)',2,.6);
    roundRect(-15,-28,30,26,10,BLUE);
    roundRect(4,-18,8,8,3,'#fff'); roundRect(6,-16,4,4,2,'#111');
    drawCapsule(-34,6,18,12,6,RED,-0.15); drawCapsule(16,6,18,12,6,RED,0.15);
    roundRect(-18,12,36,6,3,'#fff');
    ctx.restore();
  }
  bbox(){return{x:this.x+8,y:this.y+6,w:this.w-16,h:this.h-12};}
}

/* ===== –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è (–ø–æ—Ä—Ç—Ä–µ—Ç: —Å–æ–≤–º–µ—Å—Ç–∏–º—ã) ===== */
class Obstacle{
  constructor(x,t=0){
    this.x=x; this.t=t; this.passed=false;
    if(t===0){this.w=46;this.h=58;}
    else if(t===1){this.w=60;this.h=98;}
    else if(t===2){this.w=80;this.h=64;}
    else if(t===3){this.w=62;this.h=112;}
    else if(t===4){this.w=42;this.h=50;}
    this.y=groundY+player.h-this.h;
  }
  update(){
    this.x -= speed*(1+Math.min(.78, difficulty*.18));
    if(!this.passed && this.x+this.w<player.x){ this.passed=true; score+=24; (score%480===0)?SND.milestone():SND.tick(); }
  }
  draw(){
    roundRect(this.x+6,this.y+this.h-8,Math.max(24,this.w-6),8,4,'rgba(0,0,0,.12)');
    if(this.t===3){
      roundRect(this.x,this.y-10,this.w,this.h+12,12,BLUE);
      roundRect(this.x+10,this.y+8,this.w-20,this.h-30,10,'#fff');
      roundRect(this.x+14,this.y+14,this.w-28,12,6,RED);
      roundRect(this.x+14,this.y+30,this.w-28,12,6,BLUE);
    }else{
      const c=(this.t===4)?'#E04B3C':RED;
      roundRect(this.x,this.y,this.w,this.h,12,c);
      roundRect(this.x+8,this.y+8,this.w-16,6,3,'#ffffff66');
    }
  }
  bbox(){return{x:this.x+6,y:this.y+6,w:this.w-12,h:this.h-12};}
}

/* ===== —Ñ–æ–Ω (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è) ===== */
function drawBG(t){
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,W,H);

  // –≤–µ—Ä—Ö–Ω–∏–µ ¬´–æ—Å—Ç—Ä–æ–≤–∞¬ª
  roundRect(70,140,280,160,22,'#eef3ff');
  roundRect(W-350,110,260,140,22,'#eef6ea');

  // –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π ¬´–∫–∞–Ω–∞–ª¬ª
  roundRect(W/2-90, 360, 180, 600, 30, '#edf2ff');

  // –¥–∏–∞–≥–æ–Ω–∞–ª—å–Ω–∞—è –º–∞–≥–∏—Å—Ç—Ä–∞–ª—å —Å–≤–µ—Ä—Ö—É-–≤–Ω–∏–∑
  drawRibbon(t);

  // –∏–≥—Ä–æ–≤–∞—è –¥–æ—Ä–æ–≥–∞ (–Ω–∏–∑)
  const Y=groundY+player.h;
  roundRect(0,Y,W,300,26,'#f3f4fa');
  roundRect(0,Y-12,W,12,6,RED);
  const shift=(t*0.26)%72;
  for(let i=-shift;i<W;i+=72){ roundRect(i, Y+90, 48, 6, 3, 'rgba(22,42,102,.12)'); }
}

/* –≥–ª–∞–¥–∫–∞—è –¥–∏–∞–≥–æ–Ω–∞–ª—å–Ω–∞—è –ª–µ–Ω—Ç–∞ –ø–æ –ø–æ—Ä—Ç—Ä–µ—Ç—É */
function drawRibbon(t){
  const x0=80, amp=60, len=H+400;
  const x = y => x0 + Math.sin((y+t*0.0007)/180*Math.PI)*amp;

  // —Ç–µ–Ω—å
  ctx.strokeStyle='rgba(0,0,0,.08)'; ctx.lineWidth=30; ctx.lineCap='round';
  ctx.beginPath(); ctx.moveTo(x( -200 ), -200); for(let y=-200;y<len;y+=24) ctx.lineTo(x(y)+2,y+2); ctx.stroke();

  // –¥–æ—Ä–æ–≥–∞
  ctx.strokeStyle='#ffd96a'; ctx.lineWidth=28;
  ctx.beginPath(); ctx.moveTo(x(-200), -200); for(let y=-200;y<len;y+=24) ctx.lineTo(x(y), y); ctx.stroke();

  // ¬´–º–∞—à–∏–Ω–∫–∏¬ª
  for(let i=0;i<8;i++){ const cy=(t*0.18+i*220)%(H+300)-150; const cx=x(cy)+(i%2?-8:8);
    roundRect(cx-11, cy-7, 22, 14, 7, i%3===0?'#5ac8fa':(i%3===1?'#34c759':'#ff3b30')); }
}

/* ===== —á–∞—Å—Ç–∏—Ü—ã ===== */
const Particles={items:[],spawn(x,y,c){this.items.push({x,y,vx:rand(-1.2,1.2),vy:rand(-1.6,-.4),a:1,c,life:rand(.45,.8)});},
  update(dt){this.items=this.items.filter(p=>{p.vx*=.99;p.vy+=.12;p.x+=p.vx;p.y+=p.vy;p.life-=dt;p.a=Math.max(0,p.life/.8);return p.life>0;});},
  draw(){for(const p of this.items){ctx.globalAlpha=p.a;roundRect(p.x,p.y,6,6,3,p.c);}ctx.globalAlpha=1;}
};

/* ===== —Å—É—â–Ω–æ—Å—Ç–∏ –∏ —Ü–∏–∫–ª ===== */
const player=new Player();
const obstacles=[]; let spawnT=0;

function spawnObstacle(){
  const minGap=Math.max(190 - difficulty*7, 100);
  const maxGap=Math.max(330 - difficulty*5, 150);
  const lastX=obstacles.length?obstacles[obstacles.length-1].x:W+420;
  let nx=Math.max(W+rand(minGap,maxGap), lastX+rand(minGap*0.75,maxGap));
  let t=0; const r=Math.random();
  if(r<.40)t=0; else if(r<.68)t=1; else if(r<.90)t=2; else if(r<.96)t=3; else t=4;
  if(t===4){ obstacles.push(new Obstacle(nx,4)); obstacles.push(new Obstacle(nx+rand(70,100),0)); }
  else{ obstacles.push(new Obstacle(nx,t)); }
}

function resetRound(){score=0;speed=8.2;difficulty=1;spawnT=0;obstacles.length=0;player.reset();over=false;}

function step(ts){
  if(!running){last=ts;requestAnimationFrame(step);return;}
  dt=Math.min(.033,(ts-last)/1000); last=ts;

  difficulty += dt*0.82;
  speed = lerp(speed, 8.2 + difficulty*1.28, .02);

  spawnT -= dt;
  if(spawnT<=0){ spawnObstacle(); const base=clamp(1.0 - difficulty*0.028, .28, 1.0); spawnT = base + Math.random()*0.16; }

  drawBG(ts);

  for(const o of obstacles){ o.update(); o.draw(); }
  player.update(); player.draw();

  Particles.update(dt); Particles.draw();

  const pb=player.bbox();
  for(const o of obstacles){
    const b={x:o.x+6,y:o.y+6,w:o.w-12,h:o.h-12};
    if(!(pb.x+pb.w<b.x||pb.x>b.x+b.w||pb.y+pb.h<b.y||pb.y>b.y+b.h)) return gameOver();
  }
  while(obstacles.length && obstacles[0].x+obstacles[0].w<-60) obstacles.shift();

  // –±—ã—Å—Ç—Ä—ã–π —Å—á—ë—Ç –ø–æ–¥ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫–æ—É–ø
  score += Math.floor(dt*(95 + speed*9));
  document.getElementById('score').textContent=String(score);
  document.getElementById('best').textContent=String(best);

  requestAnimationFrame(step);
}

/* ===== UI / –≤–≤–æ–¥ –Ω–∏–∫–∞ / –ª–∏–¥–µ—Ä–±–æ—Ä–¥ ===== */
const startPanel=document.getElementById('startPanel');
const overPanel=document.getElementById('overPanel');
const lbPanel=document.getElementById('lbPanel');
const finalScore=document.getElementById('finalScore');
const finalBest=document.getElementById('finalBest');
const nickBadge=document.getElementById('nickBadge');
const toast=document.getElementById('toast');
const nickInput=document.getElementById('nickInput');
const startBtn=document.getElementById('startBtn');

function show(panel){startPanel.style.display='none';overPanel.style.display='none';lbPanel.style.display='none';panel.style.display='';}
function toastMsg(t){toast.textContent=t;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),1100);}

function setNick(n){
  const cleaned=(n||'').toString().trim().replace(/\s+/g,' ').replace(/[^A-Za-z0-9 _.-]/g,'');
  const key=normNick(cleaned);
  state.nick = cleaned && key ? cleaned : '';
  nickBadge.textContent='üë§ –ù–∏–∫: '+(state.nick||'‚Äî');
  store.save(state);
  startBtn.disabled = !state.nick;
}
function ensureNick(){ nickBadge.textContent='üë§ –ù–∏–∫: '+(state.nick||'‚Äî'); startBtn.disabled=!state.nick; }
nickInput.addEventListener('input', ()=> setNick(nickInput.value));

function startGame(){
  if(!state.nick) return;
  show(startPanel); startPanel.style.display='none';
  running=true; resetRound(); ensureNick();
  if(SND.a&&SND.a.state==='suspended') SND.a.resume();
  requestAnimationFrame(step);
}
function gameOver(){
  if(over) return; over=true; running=false; SND.hit();
  for(let i=0;i<26;i++) Particles.spawn(player.x+rand(-10,40), player.y+rand(0,60), Math.random()<.5?RED:BLUE);
  if(score>(state.best||0)){ state.best=score; store.save(state); best=state.best; toastMsg('–ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥! üî•'); }
  store.setBest(state.nick, score);
  finalScore.textContent=String(score);
  finalBest.textContent=String(best);
  show(overPanel);
}

/* –õ–∏–¥–µ—Ä–±–æ—Ä–¥ (—É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º—É –Ω–∏–∫—É) */
function buildLB(){
  const t=document.getElementById('lbTable'), lb=store.lb();
  const rows=Object.entries(lb).map(([key,v])=>({nick:v.nick||key,score:v.score|0,ts:v.ts|0,key}))
               .sort((a,b)=>b.score-a.score).slice(0,200);
  if(!rows.length){ t.innerHTML='<tr><td class="pos">‚Äî</td><td class="nickc">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td><td class="val">0</td></tr>'; return; }
  let html=''; rows.forEach((r,i)=>{ const me=(normNick(state.nick)===r.key);
    html+=`<tr class="${me?'me':''}"><td class="pos">${i+1}</td><td class="nickc">${escapeHtml(r.nick)}</td><td class="val">${r.score}</td></tr>`; });
  t.innerHTML=html;
}
const escapeHtml=s=>(s+'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

/* –ö–Ω–æ–ø–∫–∏ */
document.getElementById('openLbBtn').onclick=()=>{buildLB();show(lbPanel);};
document.getElementById('lbBtn2').onclick=()=>{buildLB();show(lbPanel);};
document.getElementById('backBtn').onclick=()=>{show(startPanel);};
startBtn.onclick=startGame;
document.getElementById('retryBtn').onclick=()=>{startGame();};

/* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ */
let holding=false;
const press=()=>{if(!running)return;player.startJump();holding=true;};
const release=()=>{holding=false;};
window.addEventListener('keydown',e=>{if(e.code==='Space'||e.code==='ArrowUp'){e.preventDefault();press();}});
window.addEventListener('keyup',e=>{if(e.code==='Space'||e.code==='ArrowUp'){e.preventDefault();release();}});
cvs.addEventListener('pointerdown',press); window.addEventListener('pointerup',release);
(function holdLoop(){if(running)player.holdJump(holding);requestAnimationFrame(holdLoop);})();

/* Init */
ensureNick(); document.getElementById('best').textContent=String(best);
requestAnimationFrame(step);
</script>
</body>
</html>
