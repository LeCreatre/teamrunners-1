<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>TEAM Runners</title>
<style>
  :root{
    --red:#C9301F;
    --blue:#132766;
    --ink:#0d1024;
    --bg:#ffffff;
    --muted:#667085;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{
    min-height:100%;display:flex;align-items:center;justify-content:center;padding:16px;
    background: radial-gradient(1200px 800px at 80% -10%, rgba(201,48,31,.10), transparent 60%),
                radial-gradient(1200px 900px at -10% 100%, rgba(19,39,102,.10), transparent 60%),
                #f8fafc;
  }
  .stage{
    width:min(96vw, 140vh); aspect-ratio:16/9; position:relative; overflow:hidden; border-radius:20px;
    background:#fff; box-shadow:0 24px 70px rgba(19,39,102,.25), inset 0 0 0 1px rgba(19,39,102,.08);
  }

  /* CANVAS */
  #game{position:absolute; inset:0; width:100%; height:100%; image-rendering:pixelated; background:#fff;}

  /* HUD */
  .hud{position:absolute; inset:0; pointer-events:none; padding:18px 20px; display:flex; flex-direction:column; justify-content:space-between;}
  .top{display:flex; gap:10px; align-items:center; justify-content:space-between}
  .chip{pointer-events:auto; display:inline-flex; gap:8px; align-items:center; padding:8px 12px; border-radius:999px; font-weight:800; letter-spacing:.2px; font-size:14px}
  .chip.blue{background:rgba(19,39,102,.08); color:var(--blue); box-shadow:inset 0 0 0 1px rgba(19,39,102,.12)}
  .chip.red{background:rgba(201,48,31,.08); color:var(--red); box-shadow:inset 0 0 0 1px rgba(201,48,31,.18)}
  .muted{color:var(--muted)}

  /* PANELS */
  .panel{position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.75)); backdrop-filter:blur(8px) saturate(120%);
    padding:20px;}
  .card{width:min(720px, 92%); background:#fff; border-radius:18px; padding:22px; box-shadow:0 20px 60px rgba(19,39,102,.22), inset 0 0 0 1px rgba(19,39,102,.08)}
  h1{margin:0 0 10px; color:var(--blue); font-size:28px}
  .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  input[type="text"]{width:100%; padding:12px 14px; border:1px solid rgba(19,39,102,.2); border-radius:12px; outline:none; font-size:16px}
  .btn{pointer-events:auto; display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:12px 16px; border-radius:12px; border:0; cursor:pointer; font-weight:900; letter-spacing:.2px}
  .btn.red{background:linear-gradient(135deg, var(--red), #b12a1b); color:#fff; box-shadow:0 10px 30px rgba(201,48,31,.45)}
  .btn.blue{background:linear-gradient(135deg, var(--blue), #09133f); color:#fff; box-shadow:0 10px 30px rgba(19,39,102,.45)}
  .btn.ghost{background:transparent; color:var(--blue); border:1px solid rgba(19,39,102,.25)}
  .btn:active{transform:translateY(1px)}

  /* LEADERBOARD */
  .table{width:100%; border-collapse:separate; border-spacing:0 8px; margin-top:10px; font-variant-numeric:tabular-nums}
  .table tr{background:#f6f8ff}
  .table tr.me{background:#fff3f1}
  .table td{padding:10px 12px}
  .pos{width:50px; text-align:center; font-weight:900; color:var(--blue)}
  .nick{font-weight:900}
  .val{font-weight:900; color:var(--red)}

  /* TOAST */
  .toast{position:absolute; left:50%; top:10%; transform:translateX(-50%); background:#10142a; color:#fff; padding:10px 14px; border-radius:12px; display:none}
  .toast.show{display:block; animation:pop .9s ease}
  @keyframes pop{0%{transform:translate(-50%,-10px); opacity:0} 20%{opacity:1} 80%{opacity:1} 100%{opacity:0}}
</style>
</head>
<body>
<div class="wrap">
  <div class="stage">
    <canvas id="game" width="1920" height="1080"></canvas>

    <div class="hud">
      <div class="top">
        <div class="chip blue" id="nickBadge">üë§ –ù–∏–∫: ‚Äî</div>
        <div style="display:flex; gap:10px">
          <div class="chip red"><span class="muted">–°—á—ë—Ç</span>&nbsp;<b id="score">0</b></div>
          <div class="chip blue"><span class="muted">–†–µ–∫–æ—Ä–¥</span>&nbsp;<b id="best">0</b></div>
        </div>
      </div>
      <div style="display:flex; justify-content:space-between; align-items:flex-end">
        <div class="chip blue muted">‚ê£ / ‚ñ≤ / –¢–∞–ø ‚Äî –ø—Ä—ã–∂–æ–∫ ‚Ä¢ –°–∫–æ—Ä–æ—Å—Ç—å —Ä–∞—Å—Ç—ë—Ç</div>
        <button class="btn ghost" id="btnLb" style="pointer-events:auto">üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥</button>
      </div>
    </div>

    <!-- START -->
    <div class="panel" id="startPanel">
      <div class="card">
        <h1>TEAM Runners</h1>
        <p class="muted">–ù–æ–≤—ã–π –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —Ä–∞–Ω–Ω–µ—Ä –≤ –±—Ä–µ–Ω–¥-—Ü–≤–µ—Ç–∞—Ö TEAM. –ü–µ—Ä–µ–ø—Ä—ã–≥–∏–≤–∞–π, –¥–µ—Ä–∂–∏ —Ä–∏—Ç–º, –∑–∞–±–∏—Ä–∞–π –º–µ—Å—Ç–æ –≤ —Ç–æ–ø–µ.</p>
        <div class="row" style="margin-top:12px">
          <input id="nickInput" type="text" maxlength="20" placeholder="–ù–∏–∫–Ω–µ–π–º (–ª–∞—Ç–∏–Ω–∏—Ü–∞/—Ü–∏—Ñ—Ä—ã/–ø—Ä–æ–±–µ–ª—ã)" />
          <button class="btn red" id="startBtn">‚ñ∂ –ù–∞—á–∞—Ç—å</button>
          <button class="btn blue" id="openLbBtn">üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥</button>
        </div>
      </div>
    </div>

    <!-- GAME OVER -->
    <div class="panel" id="overPanel" style="display:none">
      <div class="card">
        <h1>–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞</h1>
        <p class="muted">–°—á—ë—Ç: <b id="finalScore">0</b> ‚Ä¢ –õ—É—á—à–∏–π: <b id="finalBest">0</b></p>
        <div class="row" style="margin-top:10px">
          <button class="btn red" id="retryBtn">‚Üª –ï—â—ë —Ä–∞–∑</button>
          <button class="btn blue" id="lbBtn2">üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥</button>
        </div>
      </div>
    </div>

    <!-- LEADERBOARD -->
    <div class="panel" id="lbPanel" style="display:none">
      <div class="card">
        <h1>üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥</h1>
        <div class="row" style="justify-content:flex-end; margin:6px 0 10px">
          <button class="btn ghost" id="backBtn">‚Üê –ù–∞–∑–∞–¥</button>
          <button class="btn blue" id="renameBtn">‚úé –°–º–µ–Ω–∏—Ç—å –Ω–∏–∫</button>
          <button class="btn red" id="resetBtn">üßπ –°–±—Ä–æ—Å–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
        </div>
        <table class="table" id="lbTable"></table>
        <p class="muted" style="margin-top:8px">–õ–∏–¥–µ—Ä–±–æ—Ä–¥ —Ö—Ä–∞–Ω–∏—Ç **–ª—É—á—à–∏–π —Å—á—ë—Ç –Ω–∞ –Ω–∏–∫** –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –°—Ç–∞—Ä—ã–µ –¥—É–±–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã.</p>
      </div>
    </div>

    <div class="toast" id="toast">–ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥! üî•</div>
  </div>
</div>

<script>
/* =========================
   TEAM Runners ‚Äî clean build
   ========================= */

const BRAND_RED = '#C9301F';
const BRAND_BLUE = '#132766';
const BG = '#ffffff';

const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
const rand = (a,b)=>Math.random()*(b-a)+a;
const chance = p=>Math.random()<p;
function lerp(a,b,t){return a+(b-a)*t;}
function now(){return performance.now();}

/* ---------- Audio (no files) ---------- */
class Sound {
  constructor(){try{this.actx=new (window.AudioContext||window.webkitAudioContext)();}catch(e){}}
  beep({f=600,d=0.08,t='square',g=0.05,a=0.005,r=0.02,s=0}={}){ if(!this.actx) return;
    const c=this.actx, t0=c.currentTime, o=c.createOscillator(), gn=c.createGain();
    o.type=t; o.frequency.setValueAtTime(f,t0); if(s) o.frequency.exponentialRampToValueAtTime(Math.max(40,f+s),t0+d);
    gn.gain.setValueAtTime(0,t0); gn.gain.linearRampToValueAtTime(g,t0+a); gn.gain.setValueAtTime(g,t0+d-r); gn.gain.linearRampToValueAtTime(0,t0+d);
    o.connect(gn); gn.connect(c.destination); o.start(t0); o.stop(t0+d+.02);
  }
  jump(){this.beep({f:520,d:.09,t:'square',g:.06,s:120});}
  hit(){this.beep({f:160,d:.12,t:'sawtooth',g:.08,s:-140});}
  tick(){this.beep({f:880,d:.05,t:'triangle',g:.045});}
  milestone(){this.beep({f:640,d:.25,t:'square',g:.07,s:260});}
}
const SND = new Sound();

/* ---------- Storage with per-nick BEST aggregation ---------- */
const KEY  = 'TR_STATE_V2';
const LBKEY= 'TR_LB_V2'; // —Ö—Ä–∞–Ω–∏—Ç –æ–±—ä–µ–∫—Ç {nick:{score,ts}}
const store = {
  state(){ try{return JSON.parse(localStorage.getItem(KEY))||{nick:'',best:0};}catch(e){return {nick:'',best:0};} },
  saveState(s){ localStorage.setItem(KEY, JSON.stringify(s)); },
  getLB(){
    // –º–∏–≥—Ä–∞—Ü–∏—è —Å–æ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ (–º–∞—Å—Å–∏–≤) –≤ –æ–±—ä–µ–∫—Ç
    let raw=null; try{ raw = JSON.parse(localStorage.getItem(LBKEY)); }catch(e){}
    if (raw && typeof raw === 'object' && !Array.isArray(raw)) return raw;

    // –ø—Ä–æ–±—É–µ–º —Å—Ç–∞—Ä—ã–µ –∫–ª—é—á–∏
    let legacy=null; try{ legacy = JSON.parse(localStorage.getItem('TEAM_RUNNERS_LB_V1')); }catch(e){}
    const agg = {};
    if (Array.isArray(legacy)){
      for (const r of legacy){
        const n = (r.nick||'Player').toString().slice(0,20);
        const sc = +r.score||0;
        if (!agg[n] || sc > agg[n].score) agg[n] = {score:sc, ts:r.ts||Date.now()};
      }
      localStorage.setItem(LBKEY, JSON.stringify(agg));
      localStorage.removeItem('TEAM_RUNNERS_LB_V1');
    }
    return JSON.parse(localStorage.getItem(LBKEY)) || {};
  },
  setBest(nick, score){
    const n = (nick||'Player').toString().trim().slice(0,20).replace(/[^A-Za-z0-9 _.-]/g,'') || 'Player';
    const lb = this.getLB();
    if (!lb[n] || score > lb[n].score) lb[n] = {score, ts:Date.now()};
    localStorage.setItem(LBKEY, JSON.stringify(lb));
  },
  reset(){ localStorage.removeItem(KEY); localStorage.removeItem(LBKEY); }
};

/* ---------- Canvas ---------- */
const cvs = document.getElementById('game'), ctx = cvs.getContext('2d');
const W=cvs.width, H=cvs.height;
const groundY = H-200;
let last=0, dt=0, running=false, over=false;

/* ---------- Game state ---------- */
let score=0, best=0, speed=8, difficulty=1;
const state = store.state(); best = state.best||0;

/* ---------- Player ---------- */
class Player{
  constructor(){this.reset();}
  reset(){this.x=240; this.y=groundY; this.w=60; this.h=84; this.vy=0; this.onGround=true; this.hold=0.16; this.anim=0;}
  startJump(){if(this.onGround){this.vy=-18.8; this.onGround=false; this.hold=0.16; SND.jump();}}
  holdJump(hold){ if(hold && this.hold>0){ this.vy -= 0.9; this.hold -= dt; } }
  update(){ this.vy += 0.95; this.y += this.vy; if(this.y>=groundY){this.y=groundY; this.vy=0; this.onGround=true;} this.anim += dt*(10+speed*.5); }
  draw(){
    const x=this.x,y=this.y,w=this.w,h=this.h;
    // shadow
    ctx.fillStyle='rgba(0,0,0,.12)'; ctx.beginPath(); ctx.ellipse(x+10, groundY+h-6, 90, 14, 0, 0, Math.PI*2); ctx.fill();
    // legs
    const ph=Math.sin(this.anim*.45); ctx.fillStyle=BRAND_RED;
    ctx.fillRect(x+18, y+h-30, 16, 28); ctx.fillRect(x+28+ph*6, y+h-30, 16, 28);
    // torso
    ctx.fillRect(x+12, y+28, 40, 40);
    // head
    ctx.fillStyle=BRAND_BLUE; ctx.fillRect(x+18, y, 30, 28);
    // eye
    ctx.fillStyle='#fff'; ctx.fillRect(x+40,y+8,6,6); ctx.fillStyle='#111'; ctx.fillRect(x+42,y+10,3,3);
    // arms + stripe
    ctx.fillStyle=BRAND_RED; ctx.fillRect(x, y+36, 16, 14); ctx.fillRect(x+52,y+36,16,14);
    ctx.fillStyle='#fff'; ctx.fillRect(x+12, y+44, 40, 6);
  }
  bbox(){ return {x:this.x+6,y:this.y+6,w:this.w-12,h:this.h-12}; }
}
const player = new Player();

/* ---------- Obstacles ---------- */
class Obstacle{
  constructor(x,t=0){
    this.x=x; this.t=t; this.passed=false;
    if(t===0){this.w=46; this.h=54;}
    else if(t===1){this.w=52; this.h=92;}
    else if(t===2){this.w=72; this.h=58;}
    else {this.w=54; this.h=100;}
    this.y=groundY+player.h-this.h;
    this.color=t===3?BRAND_BLUE:BRAND_RED;
  }
  update(){
    this.x -= speed*(1+Math.min(.65, difficulty*.15));
    if(!this.passed && this.x+this.w<player.x){ this.passed=true; score+=10; ((score%200)===0)?SND.milestone():SND.tick(); }
  }
  draw(){
    ctx.fillStyle='rgba(0,0,0,.15)'; ctx.fillRect(this.x+4, this.y+this.h-6, Math.max(20,this.w), 6);
    if(this.t===3){
      ctx.fillStyle=this.color; ctx.fillRect(this.x, this.y-10, this.w, this.h+10);
      ctx.fillStyle='#fff'; ctx.fillRect(this.x+8, this.y, this.w-16, this.h-20);
      ctx.fillStyle=BRAND_RED; ctx.fillRect(this.x+12, this.y+12, this.w-24, 10);
      ctx.fillStyle=BRAND_BLUE; ctx.fillRect(this.x+12, this.y+28, this.w-24, 10);
    }else{
      ctx.fillStyle=this.color; ctx.fillRect(this.x,this.y,this.w,this.h);
      ctx.fillStyle='#fff3'; ctx.fillRect(this.x+6,this.y+6,this.w-12,6);
      ctx.fillStyle='#0002'; ctx.fillRect(this.x,this.y+this.h-6,this.w,6);
    }
  }
  bbox(){ return {x:this.x+4,y:this.y+4,w:this.w-8,h:this.h-8}; }
}
const obstacles=[]; let spawnT=0;

/* ---------- Background (–º–∏–Ω–∏–º–∞–ª–∏–∑–º: –ª–∏–Ω–∏–∏ + –¥–∏—Å–∫–∏) ---------- */
function drawBG(){
  ctx.fillStyle=BG; ctx.fillRect(0,0,W,H);
  // –Ω–µ–∂–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç
  const g=ctx.createLinearGradient(0,0,0,H*0.6); g.addColorStop(0,'rgba(19,39,102,.08)'); g.addColorStop(1,'rgba(201,48,31,.03)'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H*0.6);
  // –±–µ–≥—É—â–∏–µ –ª–∏–Ω–∏–∏ –¥–æ—Ä–æ–≥–∏
  const Y=groundY+player.h;
  ctx.fillStyle='#f3f5fb'; ctx.fillRect(0,Y,W,180);
  ctx.fillStyle=BRAND_RED+'aa'; ctx.fillRect(0,Y-10,W,10);
  ctx.fillStyle='rgba(19,39,102,.12)';
  for(let i=0;i<W;i+=80){ ctx.fillRect((i-(now()*0.2)%80), Y+70, 48, 6); }
  // –¥–∏—Å–∫–∏-¬´–æ–≥–Ω–∏ –≥–æ—Ä–æ–¥–∞¬ª
  ctx.globalAlpha=.08; ctx.fillStyle=BRAND_BLUE; for(let i=0;i<8;i++){ const r=rand(40,120); ctx.beginPath(); ctx.ellipse(rand(0,W), rand(60,380), r, r*.65, 0,0,Math.PI*2); ctx.fill(); }
  ctx.globalAlpha=1;
}

/* ---------- Particles ---------- */
const Particles={items:[], spawn(x,y,c,dx=0,dir=-1,life=.6){this.items.push({x,y,vx:(rand(-2,1)+dx)*dir,vy:rand(-2,-.5),a:1,c,life});},
  update(){this.items=this.items.filter(p=>{p.vx*=.99;p.vy+=.12;p.x+=p.vx;p.y+=p.vy;p.life-=dt;p.a=Math.max(0,p.life/.6);return p.life>0;});},
  draw(){for(const p of this.items){ctx.globalAlpha=p.a; ctx.fillStyle=p.c; ctx.fillRect(p.x,p.y,6,6);} ctx.globalAlpha=1;}
};

/* ---------- Collisions ---------- */
function collide(a,b){return !(a.x+a.w<b.x||a.x>b.x+b.w||a.y+a.h<b.y||a.y>b.y+b.h);}

/* ---------- Spawning ---------- */
function spawnObstacle(){
  const minGap=Math.max(220-difficulty*6,120);
  const maxGap=Math.max(380-difficulty*4,180);
  const lastX=obstacles.length?obstacles[obstacles.length-1].x:W+400;
  const nx=Math.max(W+rand(minGap,maxGap), lastX+rand(minGap,maxGap));
  let t=0; const r=Math.random(); if(r<.5)t=0; else if(r<.8)t=1; else if(r<.95)t=2; else t=3;
  obstacles.push(new Obstacle(nx,t));
}

/* ---------- Loop ---------- */
function resetGame(){ score=0; speed=8; difficulty=1; spawnT=0; obstacles.length=0; player.reset(); over=false; }
function step(ts){
  if(!running){ last=ts; requestAnimationFrame(step); return; }
  dt=Math.min(.033,(ts-last)/1000); last=ts;

  difficulty += dt*.75;
  speed = lerp(speed, 8 + difficulty*1.25, .02);

  spawnT -= dt; if(spawnT<=0){ spawnObstacle(); const base=clamp(1.2-difficulty*.02,.36,1.2); spawnT=base+rand(0,.25); }

  drawBG();

  for(const o of obstacles){o.update(); o.draw();}
  player.update(); player.draw();
  Particles.update(); Particles.draw();

  const pb=player.bbox();
  for(const o of obstacles){ if(collide(pb,o.bbox())){ return gameOver(); } }

  while(obstacles.length && obstacles[0].x+obstacles[0].w<-50) obstacles.shift();

  score += Math.floor(dt*(20+speed*2));
  updateHUD();
  requestAnimationFrame(step);
}

/* ---------- UI ---------- */
const startPanel=document.getElementById('startPanel');
const overPanel =document.getElementById('overPanel');
const lbPanel   =document.getElementById('lbPanel');
const scoreEl=document.getElementById('score'), bestEl=document.getElementById('best');
const finalScore=document.getElementById('finalScore'), finalBest=document.getElementById('finalBest');
const nickBadge=document.getElementById('nickBadge'), toast=document.getElementById('toast');

function show(panel){ startPanel.style.display='none'; overPanel.style.display='none'; lbPanel.style.display='none'; panel.style.display=''; }
function toastMsg(t){ toast.textContent=t; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1100); }

function setNick(n){ const safe=(n||'').toString().trim().slice(0,20).replace(/[^A-Za-z0-9 _.-]/g,''); state.nick = safe || 'Player'; nickBadge.textContent='üë§ –ù–∏–∫: '+state.nick; store.saveState({...state}); }
function ensureNick(){ if(!state.nick) setNick('Player'); nickBadge.textContent='üë§ –ù–∏–∫: '+(state.nick||'Player'); }

function startGame(){ show(startPanel); startPanel.style.display='none'; running=true; resetGame(); ensureNick(); if(SND.actx&&SND.actx.state==='suspended') SND.actx.resume(); requestAnimationFrame(step); }
function gameOver(){
  if(over) return; over=true; running=false; SND.hit();
  for(let i=0;i<24;i++) Particles.spawn(player.x+rand(-10,50), player.y+rand(0,60), chance(.5)?BRAND_RED:BRAND_BLUE, rand(-2,2), -1, rand(.4,.9));

  // –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π BEST (–ø–µ—Ä—Å.) –∏ –æ–±—â–∏–π LB (–Ω–∞ –Ω–∏–∫)
  if(score > (state.best||0)){ state.best=score; store.saveState(state); toastMsg('–ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥! üî•'); }
  store.setBest(state.nick||'Player', score);

  best = state.best||0;
  bestEl.textContent = best.toString();
  finalScore.textContent = score.toString();
  finalBest.textContent = best.toString();
  show(overPanel);
}

function updateHUD(){ scoreEl.textContent=score.toString(); bestEl.textContent=(state.best||0).toString(); }

/* ---------- Leaderboard (per-nick best only) ---------- */
function buildLB(){
  const t=document.getElementById('lbTable');
  const lbObj = store.getLB();
  const rows = Object.entries(lbObj).map(([nick, v])=>({nick, score:v.score|0, ts:v.ts|0}))
                 .sort((a,b)=>b.score-a.score).slice(0,200);
  if(!rows.length){ t.innerHTML='<tr><td class="pos">‚Äî</td><td class="nick">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td><td class="val">0</td></tr>'; return; }
  let html=''; for(let i=0;i<rows.length;i++){
    const r=rows[i], me=(r.nick===(state.nick||'Player'));
    html+=`<tr class="${me?'me':''}"><td class="pos">${i+1}</td><td class="nick">${escapeHtml(r.nick)}</td><td class="val">${r.score}</td></tr>`;
  }
  t.innerHTML=html;
}
function escapeHtml(s){return (s+'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

/* ---------- Controls ---------- */
let holding=false;
function press(){ if(!running) return; player.startJump(); holding=true; }
function release(){ holding=false; }
window.addEventListener('keydown',e=>{ if(e.code==='Space'||e.code==='ArrowUp'){ e.preventDefault(); press(); } });
window.addEventListener('keyup',e=>{ if(e.code==='Space'||e.code==='ArrowUp'){ e.preventDefault(); release(); } });
cvs.addEventListener('pointerdown', press); window.addEventListener('pointerup', release);
(function holdLoop(){ if(running) player.holdJump(holding); requestAnimationFrame(holdLoop); })();

/* ---------- Buttons ---------- */
document.getElementById('startBtn').onclick=()=>{ const v=document.getElementById('nickInput').value; if(v) setNick(v); startGame(); };
document.getElementById('openLbBtn').onclick=()=>{ buildLB(); show(lbPanel); };
document.getElementById('btnLb').onclick=()=>{ buildLB(); show(lbPanel); };
document.getElementById('lbBtn2').onclick=()=>{ buildLB(); show(lbPanel); };
document.getElementById('retryBtn').onclick=()=>{ startGame(); };
document.getElementById('backBtn').onclick=()=>{ show(startPanel); };
document.getElementById('resetBtn').onclick=()=>{ store.reset(); state.nick=''; state.best=0; best=0; ensureNick(); bestEl.textContent='0'; buildLB(); toastMsg('–°–±—Ä–æ—à–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ'); };
document.getElementById('renameBtn').onclick=()=>{ const n=prompt('–ù–æ–≤—ã–π –Ω–∏–∫ (–¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤):', state.nick||'Player'); if(n!==null){ setNick(n); buildLB(); } };

/* ---------- Init ---------- */
ensureNick(); bestEl.textContent=(state.best||0).toString(); updateHUD(); buildLB();
requestAnimationFrame(step);
</script>
</body>
</html>
